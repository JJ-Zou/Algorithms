

#### 远程调用过程

**服务提供者启动过程**

- 服务实现类使用注解标记协议、注册中心等配置，在Spring启动时根据ref接口名、版本等信息创建ServiceBean引用实现类ref提供调用
- ServiceBean完成单例创建后（实现SmartInitializingSingleton接口），使用线程池启动暴露服务
- 校验协议配置、注册中心配置、接口类和方法配置，无误后开始生成注册中心URL，服务URL（包括协议、主机名、端口、服务接口名、版本等信息），可以提取出服务的CallID（协议://host:port/group/path/version）
- 根据URL生成服务提供者代理，用于治理服务，根据URL中获取的本地IP端口信息获取缓存的服务提供者路由，根据该路由信息开启并缓存网络服务监听消费者请求
- 根据注册中心URL创建并缓存注册中心，根据服务URL在注册中心注册临时节点（/protocol/group/path/version/type/host:port）

**服务消费者启动过程**

- 服务消费者作为Bean内字段被引用，通过Spring依赖注入注入Bean中。
- 根据消费者接口字段注解标记协议、注册中心等配置，在进行依赖注入填充属性时，为接口创建代理对象拦截调用方法，代理对象通过FactoryBean创建封装动态代理过程
- 校验协议配置、注册中心配置、接口类和方法配置，无误后开始生成注册中心URL，引用URL（根据引用URL的protocol、group和接口路径可以得到服务提供者的路径），订阅服务，注册监听回调
- 订阅服务后进行一次服务发现，得到服务列表并通知监听器，监听器对每个服务发起TCP连接请求维持长连接并存入缓存，刷新客户端集群上的服务列表
- 通过动态代理技术，创建服务引用代理对象并传入客户端集群

**一次服务调用**

- 消费者通过接口调用远程方法，被代理类拦截
- 代理类发起TCP请求，传递接口名称、方法名称、参数列表、参数列表签名，从集群中根据负载均衡策略选取服务方传递TCP数据包
- 服务提供方接收到TCP请求包，取出信息生成服务key，从缓存中获取服务提供者代理，得到服务实现类引用进行反射调用，将结果（可能是异常）通过TCP传回服务消费者
- 服务消费者得到返回结果完成一次调用

#### SPI增强

Service provider interface是一种服务发现机制，通过线程上下文类加载器破环双亲委派机制，尝试首先加载类路径下的类，可以进行扩展点自动加载。
